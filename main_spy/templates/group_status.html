<!doctype html>
<html>
<head>
<title>Group {{ group_id }} users stats</title>
<style>
@font-face {
	font-family: 'Segoe UI';
	src: url('{{ STATIC_URL }}fonts/segoeuil.ttf');
}

body {
	font-family: 'Segoe UI';
}

div.header {
	font-family: 'Segoe UI';
	font-size: 24px;
	padding-bottom: 20px;
}

span.emphasize {
	color: #ff6600
}

#group_stats_snapshot {
	margin-left: 6px;
	font-family: 'Segoe UI';
	width: 800px;
	font-size:14px;
}

div.snapshot-cell {
	float: left;
	margin: 3px 10px 10px 3px;
}

span.snapshot-cell-value {
	font-size: 18px;
}

#group_stats_snapshot_header {
	font-family: "Segoe UI";
	font-size: 20px;
	margin-left:10px;
	margin-bottom: 15px;
	margin-top:-9px;
}

span.snapshot-cell-additional-info {
	font-size: 12px;
	color: grey;
}

input.date-pick {
	width: 80px;
}

div.chart_container {
	margin-bottom: 20px;
	width: 800px;
	height: 500px;
}

</style>

<script src="{{ STATIC_URL }}js/jquery.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/highcharts.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/highstock.src.js" type="text/javascript"></script>
<script>
var chart1; // globally available
$(document).ready(function() {
	date_now = Math.round (new Date().getTime() / 1000)
	back_for_month = date_now - 90 * 24 * 60 * 60

	// snapshot
	var snapshot_decoration = {
		"banned_users": {
			title: "Banned users",
			addition: function (data) {return " <span class='snapshot-cell-additional-info'>(" + ((100 * data.banned_users.latest / data.total_users.latest).toPrecision(2)) + "%)</span>"},
			reverse_color_delta: true
		},
		"faceless_users": {
			title: "Faceless users",
			addition: function (data) {return " <span class='snapshot-cell-additional-info'>(" + ((100 * data.faceless_users.latest / data.total_users.latest).toPrecision(2)) + "%)</span>"},
			reverse_color_delta: true
		},
		"total_users": {
			title: "Total users",
			reverse_color_delta: false
		},
		"active_posts_count": {
			title: "Active posts count",
			reverse_color_delta: false
		},
		"active_posts_likes": {
			title: "Total likes (a.p.)",
			addition: function (data) {return " <span class='snapshot-cell-additional-info'>(" + (Math.round(data.active_posts_likes.latest / data.active_posts_count.latest)) + " avg)</span>"},
			reverse_color_delta: false
		},
		"active_posts_reposts": {
			title: "Total reposts (a.p.)",
			addition: function (data) {return " <span class='snapshot-cell-additional-info'>(" + (Math.round(data.active_posts_reposts.latest / data.active_posts_count.latest)) + " avg)</span>"},
			reverse_color_delta: false
		},
		"active_posts_comments": {
			title: "Total comments (a.p.)",
			addition: function (data) {return " <span class='snapshot-cell-additional-info'>(" + (Math.round(data.active_posts_comments.latest / data.active_posts_count.latest)) + " avg)</span>"},
			reverse_color_delta: false
		},			
	};
	$.ajax ({		
		url: '/group{{ group_id }}/snapshot/',
		success: function(data) {
			data = data.response
			div = $("#group_stats_snapshot")[0]
			var order = ["total_users", "faceless_users", "banned_users", "BREAK", "active_posts_count", "active_posts_likes", "active_posts_reposts", "active_posts_comments"]
			current_div = $("<div style='clear:both'></div>")[0]
			div.appendChild (current_div)
			for (var i = 0, l = order.length; i < l; i++) {
				var key = order[i]
				if (key == "BREAK") {
					current_div = $("<div style='clear:both'></div>")[0]
					div.appendChild (current_div)
				} else {
					cell = $("<div class='snapshot-cell'></div>")[0]
					var dec = snapshot_decoration[key] 
					
					var c1 = dec.reverse_color_delta ? "#ff0000": "#55aa55"
					var c2 = dec.reverse_color_delta ? "#55aa55" : "#ff0000" 
					if (data[key].week_ago != "undefined") {
						var color = data[key].latest >= data[key].week_ago ? c1 : c2
					} else if (data[key].day_ago != "undefined") {
						color = data[key].latest >= data[key].day_ago ? c1 : c2
					} else {
						color = '#000000'
					}
					
					var title = ''
					function create_title_part(label, now, prev) {
						if (prev == "undefined") {
							percentage = "no data"
						} else {
							var p = 100 * (now - prev) / prev
							if (p > 0)
								var percentage = "+" + p.toPrecision(4) + "%"
							else 
								percentage = p.toPrecision(4) + "%"
						}
						return label + ": " + percentage + "  "
					}
					title += create_title_part("Day ago", data[key].latest, data[key].day_ago)
					title += create_title_part("Week ago", data[key].latest, data[key].week_ago)
					title += create_title_part("Month ago", data[key].latest, data[key].month_ago)
					
					cell.innerHTML = dec.title + ": <span title='" + title + "' class='snapshot-cell-value' style='color:" + color + "'>" + data[key].latest + "</span>"
					if (dec.addition) {
						cell.innerHTML += dec.addition(data)
					}
					current_div.appendChild(cell)
				}			
			}
		}
	});
	
	// group users/activity diagrams
	function process_series_response(update, index, chart) {
		//console.log (data)
		current_series = chart.series[index].data
		
		var cur_update_index = 0
		var cur_series_index = 0
		var update_len = update.length
		var series_len = current_series.length
		var points_to_add = []
		while (cur_update_index < update_len) {
			if (cur_series_index >= series_len) {
				for (var i = cur_update_index; i < update_len; i++)
					points_to_add.push (update[i])
				break
			}
			var date_update = update[cur_update_index][0]
			var date_series = current_series[cur_series_index][0]
			if (date_update > date_series) {
				cur_series_index++
			} else if (date_update < date_series) {
				points_to_add.push (update[cur_update_index])
				cur_update_index++
			} else {
				cur_series_index++
				cur_update_index++
			}
		}
		
		for (var i = 0, l = points_to_add.length; i < l; i++) {
			chart.series[index].addPoint (points_to_add[i])
		}
		
		//chart.setSize(800, 500)
	}
	
	function make_request(t1, t2, stat_id, index, chart) {
		$.ajax ({
			url: '/series/group{{ group_id }}/' + stat_id + '/' + t1 + '/' + t2 + '/',
			success: function(data) { process_series_response(data.response.series, index, chart) }
		});
	}
	
	function create_line_chart(chart_description, refresh_func) {
		var opts = chart_description.series_opts
		var series_objs = [{name: 'x', data: []}]
		for (var j = 0, ln = opts.length; j < ln; j++)
			series_objs.push({
				type: 'line',
				name: opts[j].label,
				color: opts[j].color,
				data: [[0, 0], [1, 1]],
				lineWidth: 1
			});
		var chart = new Highcharts.StockChart({
			chart: {
				renderTo: chart_description.container,
				width: 800,
				height: 500,
				zoomType: 'x',
				events: {
					selection: function(event) {
						if (event.xAxis) {
							refresh_func (chart_description, Math.round (event.xAxis[0].min / 1000), Math.round (event.xAxis[0].max / 1000))
						}
					}
				},
				animation: false
			},
			title: {
				text: chart_description.title,
				style: {
					"font-family": "Segoe UI",
					"color": "#000000",
					"font-size": "20px",
				},
				align: "left",
				x: 0,
				margin: 50
			},
			xAxis: {
				type: 'datetime',
				min: back_for_month * 1000,
				showLastLabel: true,
				maxPadding: 0.0
			},
			yAxis: {
				title: {
					text: 'Count'
				},
				min: 0
			},
			plotOptions: {
				line: {marker: {
						enabled: false,
						states: {
							hover: {
								enabled: true,
								radius: 5
							}
						}
					},
					shadow: false
				}
			},
			series: series_objs
		});
		chart_description.chart = chart	
	}
	
	function refresh_groupwide_charts(chart_desc, t1, t2) {
		for (var i = 0, l = chart_desc.series_opts.length; i < l; i++)
			make_request(t1, t2, chart_desc.series_opts[i].stat_id, chart_desc.series_opts[i].index, chart_desc.chart)
	}
	
	series_opts_group_users_chart = [
		{ color: '#0000ff', label: "Total users", stat_id: "total_users", index: 0},
		{ color: '#ff6600', label: "Faceless users", stat_id: "faceless_users", index: 1},
		{ color: '#ff0000', label: "Banned users", stat_id: "banned_users", index: 2}
	]
	
	series_opts_group_activity_chart = [
		{ color: '#00ff00', label: "Active posts count", stat_id: "active_posts_count", index: 0},
		{ color: '#ff0000', label: "Total likes (active posts)", stat_id: "active_posts_likes", index: 1 },
		{ color: '#ff6600', label: "Total comments (active posts)", stat_id: "active_posts_comments", index: 2},
		{ color: '#0000ff', label: "Total reposts (active posts)", stat_id: "active_posts_reposts", index: 3}
	]

	group_charts = [
		{ title: 'General users stats', series_opts: series_opts_group_users_chart, container: "group_users_chart" },
		{ title: 'General activity stats', series_opts: series_opts_group_activity_chart, container: "group_activity_chart" }
	]
	
	for (var i = 0, l = group_charts.length; i < l; i++) {
		create_line_chart(group_charts[i], refresh_groupwide_charts)
	}

	for (var i = 0, l = group_charts.length; i < l; i++) {
		refresh_groupwide_charts(group_charts[i], back_for_month, date_now)
	}
	
	/* stratification charts */
	strata_charts = [
		{
			container: 'social_activity_hourly_stratified',
			title: 'Social activity by hours',
			strata_type: 'intraday_stratify',
			strata_labels: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
			key_func: function (key) { return parseInt(key) }
		},
		{
			container: 'social_activity_daily_stratified',
			title: 'Social activity by days of week',
			strata_type: 'intraweek_stratify',
			strata_labels: [0, 1, 2, 3, 4, 5, 6],
			key_func: function (key) { return parseInt(key) }
		},
		{
			container: 'social_activity_content_stratified',
			title: 'Social activity by content type',
			strata_type: 'content_stratify',
			strata_labels: ['app', 'audio', 'doc', 'graffiti', 'link', 'no_attachment', 'note', 'page', 'photo', 'poll', 'posted_photo', 'video'],
			key_func: function (key) { return key }
		}		
	]
	
	for (var i = 0, l = strata_charts.length; i < l; i++) {
		var params = strata_charts[i]
		var schart = new Highcharts.Chart({
			chart: {
				renderTo: params.container,
				defaultSeriesType: 'column',
				width: 800,
				height: 500
			},
			tooltip: {
				formatter: function() {
					return '<b>'+ this.x +'</b><br/>'+
						this.series.name +': '+ this.y +'<br/>'+
						'Total: '+ this.point.stackTotal;
				}
			},
			title: {
				text: params.title,
				style: {
					"font-family": "Segoe UI",
					"color": "#000000",
					"font-size": "20px",
				},
				align: "left",
				x: 0,
				margin: 50
			},
			xAxis: {
				categories: params.strata_labels
			},
			yAxis: {
				min: 0,
				title: {
					text: 'Count'
				}
			},
			plotOptions: {
				series: {
					stacking: 'normal'
				}
			}
		});
		schart.addSeries({name: "Likes"})
		schart.addSeries({name: "Reposts"})
		schart.addSeries({name: "Comments"})
		params.chart = schart
	}
	
	function make_stratas_request(params, t1, t2) {
		var series_types = {
			active_posts_likes: [],
			active_posts_comments: [],
			active_posts_reposts: []
		}
		$.ajax({
			url: '/group{{group_id}}/' + params.strata_type + '/' + t1 + '/' + t2 + '/',
			success: function (data) {
				data = data.response
				var list = []
				for (var e in data)
					list.push ([e, data[e]])
				list.sort (function (x, y) {
					x = params.key_func(x[0])
					y = params.key_func(y[0])
					if (x > y)
						return 1
					else if (x < y)
						return -1
					else
						return 0
				})
				for (var i = 0, l = list.length; i < l; i++) {
					var stats = list[i][1].stats
					for (var t in series_types) {
						series_types[t].push(stats["active_posts_count"] > 0 ? stats[t] / stats["active_posts_count"] : 0)
					}
				}
				params.chart.series[0].setData(series_types["active_posts_likes"])
				params.chart.series[1].setData(series_types["active_posts_reposts"])
				params.chart.series[2].setData(series_types["active_posts_comments"])
			}
		});
	}
	
	for (i = 0, l = strata_charts.length; i < l; i++)
		make_stratas_request(strata_charts[i], back_for_month, date_now)
	
	// social dynamics
	var series_opts_soc_dynamics_chart = [
		{ color: '#ff0000', label: "Likes", stat_id: "likes", index: 0 },
		{ color: '#ff6600', label: "Posts", stat_id: "comments", index: 1},
		{ color: '#0000ff', label: "Reposts", stat_id: "reposts", index: 2}
	]
	
	function refresh_social_dynamics_chart(chart_desc, t1, t2) {
		make_social_dynamics_request(t1, t2, '', soc_dynamics_chart_desc)
	}
	
	function make_social_dynamics_request(t1, t2, content_types, description) {
		$.ajax ({
			url: '/series/group{{ group_id }}/social_dynamics_all/' + content_types + '/' + t1 + '/' + t2 + '/',
			success: function(data) { 
				var series_info = description.series_opts
				//console.log(data.response['likes'].series)
				for (var i = 0, l = series_info.length; i < l; i++) {
					//console.log(series_info[i])
					var series = data.response[series_info[i].stat_id].series
					if (series[series.length - 1][1] == 0)
						series.pop()
					process_series_response(series, series_info[i].index, description.chart) 
				}
			}
		});	
	}
	
	var soc_dynamics_chart_desc = { title: 'Social activity dynamics', series_opts: series_opts_soc_dynamics_chart, container: "group_social_activity_dynamics" }
	create_line_chart(soc_dynamics_chart_desc, refresh_social_dynamics_chart)
	refresh_social_dynamics_chart(soc_dynamics_chart_desc, back_for_month, date_now)
});
</script>
</head>
<body>
<div id="group_stats_snapshot_header">Stats snapshot</div>
<div id="group_stats_snapshot"></div>
<div id="group_users_chart" class="chart_container" style="margin-top: 50px; clear: both"></div>
<div id="group_activity_chart" class="chart_container"></div>
<div id="group_social_activity_dynamics" class="chart_container"></div>
<div id="social_activity_hourly_stratified" class="chart_container"></div>
<div id="social_activity_daily_stratified" class="chart_container"></div>
<div id="social_activity_content_stratified" class="chart_container"></div>
<script>
/*total_users = []
banned_users = []
faceless_users = []
labels = []
{% for v in values.total_users %}
	total_users[{{ forloop.counter0 }}] = [Date.UTC ({{ v.time }}), {{ v.value }}, '{{ v.raw_time }}', '{{ v.value }} at {{ v.raw_time }}']
{% endfor %}
{% for v in values.banned_users %}
	banned_users[{{ forloop.counter0 }}] = [Date.UTC ({{ v.time }}), {{ v.value }}, '{{ v.raw_time }}', '{{ v.value }} at {{ v.raw_time }}']
{% endfor %}
{% for v in values.faceless_users %}
	faceless_users[{{ forloop.counter0 }}] = [Date.UTC ({{ v.time }}), {{ v.value }}, '{{ v.raw_time }}', '{{ v.value }} at {{ v.raw_time }}']
{% endfor %}

window.onload = function () {
    line = new RGraph.Scatter("myCanvasTag", [total_users, banned_users, faceless_users]);
	line.Set('chart.line', true);
	line.Set('chart.xmin', total_users[0][0]);
    line.Set('chart.xmax', total_users[total_users.length - 1][0]);
	line.Set('chart.line.colors', ['blue', 'red', 'orange']);
	line.Set("chart.text.font", "Myriad Pro")
	line.Set("chart.gutter.left", 60)
	line.Set("chart.gutter.top", 40)
	line.Set("chart.gutter.right", 160)
	line.Set("chart.key", ["Total users", "Banned users", "Faceless users"])
	line.Set('chart.key.position', 'gutter');
	line.Set('chart.tickmarks', null);
	line.Set('chart.tooltips.effect', 'snap');
	line.Set("chart.labels", [[total_users[0][2], total_users[0][0]], [total_users[total_users.length - 1][2], total_users[total_users.length - 1][0]]])
	//line.Set('chart.labels.specific.align', 'center');
    line.Draw();
	
	
	
	//line2 = new RGraph.Line("myCanvasTag", [10, 20, 30 , 40, 50, 60, 70, 80, 90, 85, 80, 50])
	//line2.Set ('chart.colors', ['blue'])
	//line2.Draw ()
}
*/
/*element = document.createElement ("div")
element.innerHTML = "<div style='margin-top: 15px; margin-left: 60px; font-family: \"Segoe UI\"'>Total users: " + total_users[total_users.length - 1][1] + "</div>"
					+ "<div style='margin-left: 60px; font-family: \"Segoe UI\"'>Banned users: " + banned_users[total_users.length - 1][1] + " (" + (100 * banned_users[banned_users.length - 1][1] / total_users[total_users.length - 1][1]).toPrecision(2) + "%)</div>"
					+ "<div style='margin-left: 60px; font-family: \"Segoe UI\"'>Faceless users: " + faceless_users[total_users.length - 1][1] + " (" + (100 * faceless_users[banned_users.length - 1][1] / total_users[total_users.length - 1][1]).toPrecision(2) + "%)</div>"
document.body.appendChild (element)*/
</script>
</body>
</html>